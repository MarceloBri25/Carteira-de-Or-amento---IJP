{% extends "home.html" %}
{% load custom_filters %}

{% block title %}Jornada do Cliente{% endblock %}

{% block content %}
<link href="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/css/tom-select.bootstrap5.min.css" rel="stylesheet">
<style>
.budget-container {
    background-color: #fff;
    border-radius: 8px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.05);
    margin-bottom: 2rem;
    overflow: hidden;
    transition: box-shadow .3s ease;
    border: 1px solid #dee2e6;
}
.budget-container:hover {
    box-shadow: 0 8px 25px rgba(0,0,0,0.1);
}

.client-info-section {
    padding: 1.5rem;
    border-right: 1px solid #dee2e6;
    display: flex;
    flex-direction: column;
    height: 100%;
}
.client-info-header h5 {
    margin: 0;
    font-weight: 700;
    color: #343a40;
    padding-bottom: 1rem;
    border-bottom: 1px solid #f1f1f1;
}
.client-info-body {
    padding: 1.5rem 0;
    flex-grow: 1;
}
.info-list {
    list-style: none;
    padding: 0;
    margin: 0;
}
.info-item {
    display: flex;
    align-items: center;
    margin-bottom: 1rem;
    font-size: 0.95rem;
}
.info-icon {
    color: #0d6efd;
    font-size: 1.2rem;
    width: 30px;
    text-align: center;
    margin-right: 1rem;
}
.info-value {
    color: #495057;
}

.client-info-footer {
    padding: 1rem;
    text-align: center;
    font-weight: 700;
    font-size: 1rem;
    background-color: #f8f9fa;
    border-radius: 6px;
    margin-top: 1.5rem;
}
.client-info-footer.closed-won-footer {
    background-color: #28a745; /* Green color for success */
    color: white;
}

/* Chat Styles */
.chat-container {
    display: flex;
    flex-direction: column;
    height: 100%;
}
.chat-header {
    background-color: #f7f7f7;
    color: #343a40;
    padding: 1rem 1.5rem;
    border-bottom: 1px solid #dee2e6;
}
.chat-header h5 {
    margin: 0;
    font-weight: 700;
}
.chat-body {
    padding: 1rem;
    overflow-y: auto;
    flex-grow: 1;
    background-color: #f8f9fa;
    display: flex;
    flex-direction: column;
}
.chat-message {
    margin-bottom: 1rem;
    display: flex;
    flex-direction: column;
}
.chat-message .message-bubble {
    padding: 0.75rem 1rem;
    border-radius: 1.25rem;
    max-width: 85%;
    word-wrap: break-word;
    line-height: 1.4;
}
.chat-message .message-meta {
    font-size: 0.75rem;
    color: #6c757d;
    margin-top: 0.25rem;
}
.chat-message .message-meta .message-author {
    font-weight: bold;
    color: #343a40;
    font-size: 0.85rem;
}

/* Current user's messages */
.chat-message.me {
    align-items: flex-end;
}
.chat-message.me .message-bubble {
    background-color: #0d6efd;
    color: white;
    border-bottom-right-radius: 0.5rem;
}
.chat-message.me .message-meta {
    align-self: flex-end;
}

/* Other users' messages */
.chat-message.other {
    align-items: flex-start;
}
.chat-message.other .message-bubble {
    background-color: #e9ecef;
    color: #212529;
    border-bottom-left-radius: 0.5rem;
}
.chat-message.other .message-meta {
    align-self: flex-start;
}

.chat-footer {
    padding: 1rem 1.5rem;
    background-color: #fff;
    border-top: 1px solid #dee2e6;
}
</style>

<div class="container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="mb-0">Jornada do Cliente</h2>
        <button type="button" class="btn btn-outline-secondary btn-md" data-bs-toggle="collapse" data-bs-target="#filterCollapse">
            <i class="fas fa-filter"></i> Filtros
        </button>
    </div>

    <div class="collapse mb-4" id="filterCollapse">
        <div class="card card-body">
            <form method="get" action="{% if user.role == 'gerente' %}{% url 'meus_clientes_gerente' %}{% elif user.role == 'consultor' %}{% url 'meus_clientes_consultor' %}{% elif user.role == 'administrador' %}{% url 'meus_clientes_administrador' %}{% endif %}">
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label for="filter-year" class="form-label">Ano de Fechamento</label>
                        <select class="form-select" id="filter-year" name="year">
                            <option value="">Todos</option>
                            {% for year_num in available_years %}
                                <option value="{{ year_num }}" {% if request.GET.year|default:"" == year_num|stringformat:"s" %}selected{% endif %}>
                                    {{ year_num }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="filter-month" class="form-label">Mês de Fechamento</label>
                        <select class="form-select" id="filter-month" name="month">
                            <option value="">Todos</option>
                            {% for month_num in 12|get_range %}
                                <option value="{{ month_num }}" {% if request.GET.month|default:"" == month_num|stringformat:"s" %}selected{% endif %}>
                                    {{ month_num|month_name }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="filter-especificador" class="form-label">Especificador</label>
                        <select id="filter-especificador" name="especificador">
                            <option value="">Todos</option>
                            {% for especificador in all_especificadores %}
                                <option value="{{ especificador.id }}" {% if request.GET.especificador|default:"" == especificador.id|stringformat:"s" %}selected{% endif %}>
                                    {{ especificador.nome_completo }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label for="filter-cliente" class="form-label">Cliente</label>
                        <select id="filter-cliente" name="cliente">
                            <option value="">Todos</option>
                            {% for cliente in all_clientes %}
                                <option value="{{ cliente.id }}" {% if request.GET.cliente|default:"" == cliente.id|stringformat:"s" %}selected{% endif %}>
                                    {{ cliente.nome_completo }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="filter-etapa" class="form-label">Etapa</label>
                        <select class="form-select" id="filter-etapa" name="etapa">
                            <option value="">Todas</option>
                            {% for value, name in stage_choices %}
                                <option value="{{ value }}" {% if request.GET.etapa|default:"" == value %}selected{% endif %}>{{ name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="filter-termometro" class="form-label">Status</label>
                        <select class="form-select" id="filter-termometro" name="termometro" multiple>
                            {% for value, name in thermometer_choices %}
                                <option value="{{ value }}" {% if value in selected_termometro %}selected{% endif %}>{{ name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <button type="submit" class="btn btn-dark me-2"><i class="fas fa-filter"></i> Filtrar</button>
                <a href="{% if user.role == 'gerente' %}{% url 'meus_clientes_gerente' %}{% elif user.role == 'consultor' %}{% url 'meus_clientes_consultor' %}{% endif %}" class="btn btn-secondary"><i class="fas fa-times"></i> Limpar</a>
            </form>
        </div>
    </div>

    {% for orcamento in orcamentos %}
    <div class="budget-container" id="orcamento-{{ orcamento.pk }}">
        <div class="row g-0">
            <div class="col-md-5">
                <div class="client-info-section">
                    <div class="client-info-header">
                        <h5>{{ orcamento.nome_cliente.nome_completo }}</h5>
                    </div>
                    <div class="client-info-body">
                        <ul class="info-list">
                            <li class="info-item">
                                <i class="fas fa-user info-icon"></i>
                                <span class="info-value"><strong>Especificador:</strong> {{ orcamento.especificador.nome_completo|default:"N/A" }}</span>
                            </li>
                            <li class="info-item">
                                <i class="fas fa-dollar-sign info-icon"></i>
                                <span class="info-value"><strong>Valor:</strong> R$ {{ orcamento.valor_orcamento|br_format }}</span>
                            </li>
                            <li class="info-item">
                                <i class="fas fa-user-tie info-icon"></i>
                                <span class="info-value"><strong>Consultor:</strong> {{ orcamento.usuario.get_full_name|default:orcamento.usuario.username }}</span>
                            </li>
                            <li class="info-item">
                                <i class="fas fa-calendar-alt info-icon"></i>
                                <span class="info-value"><strong>Solicitação:</strong> {{ orcamento.data_solicitacao|date:"d/m/Y" }}</span>
                            </li>
                            <li class="info-item">
                                <i class="fas fa-check-circle info-icon"></i>
                                <span class="info-value"><strong>Fechado em:</strong> 
                                    {% if orcamento.data_fechada_ganha %}
                                        {{ orcamento.data_fechada_ganha|date:"d/m/Y" }}
                                    {% else %}
                                        Em aberto
                                    {% endif %}
                                </span>
                            </li>
                        </ul>
                    </div>
                    <div class="client-info-footer {% if orcamento.etapa == 'Fechada e Ganha' %}closed-won-footer{% endif %}">
                        {% if orcamento.etapa == 'Fechada e Ganha' %}
                            <i class="fas fa-trophy"></i> Venda fechada em {{ orcamento.dias_para_fechar }} dias
                        {% elif orcamento.dias_para_fechar is not None %}
                            <i class="fas fa-hourglass-end"></i> {{ orcamento.dias_para_fechar }} dias para fechar
                        {% elif orcamento.dias_em_aberto is not None %}
                            <i class="fas fa-hourglass-start"></i> Em aberto por {{ orcamento.dias_em_aberto }} dias
                        {% else %}
                            <span>-</span>
                        {% endif %}
                    </div>
                </div>
            </div>
            <div class="col-md-7">
                <div class="chat-container">
                    <div class="chat-header">
                        <h5 class="mb-0">Jornada do Cliente</h5>
                    </div>
                    <div class="chat-body">
                        {% for item in orcamento.jornada_completa %}
                            <div class="chat-message {% if item.usuario == request.user %}me{% else %}other{% endif %}">
                                <div class="message-bubble">
                                    {{ item.comentario }}
                                </div>
                                <div class="message-meta">
                                    <span class="message-author">{{ item.usuario.username }}</span> | <span>{{ item.data|date:"d/m/Y H:i" }}</span>
                                </div>
                            </div>
                        {% empty %}
                            <div class="text-center text-muted p-5">Nenhum comentário na jornada ainda.</div>
                        {% endfor %}
                    </div>
                    <div class="chat-footer">
                        <form method="post" action="{% url 'add_jornada_cliente_comment' orcamento.pk %}">
                            {% csrf_token %}
                            <div class="input-group">
                                <textarea name="comentario" class="form-control" placeholder="Adicionar um novo comentário..." rows="2" required></textarea>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-paper-plane"></i> Enviar
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/js/tom-select.complete.min.js"></script>
<script>
    new TomSelect('#filter-cliente', {
        create: false,
        sortField: {
            field: "text",
            direction: "asc"
        }
    });
    new TomSelect('#filter-especificador', {
        create: false,
        sortField: {
            field: "text",
            direction: "asc"
        }
    });
    new TomSelect('#filter-termometro', {
        plugins: ['remove_button'],
        placeholder: 'Selecione um ou mais status',
        create: false
    });
</script>
{% endblock %}