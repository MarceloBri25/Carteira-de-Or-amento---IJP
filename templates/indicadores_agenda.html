{% extends 'home.html' %}
{% load static %}
{% load custom_filters %}

{% block title %}Indicadores de Agenda - IJP Umbrella System{% endblock %}

{% block content %}
<div class="container-fluid mt-4">

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="mb-0"><i class="fas fa-chart-line me-2"></i>Indicadores de Agendamento</h2>
    </div>

    <!-- Filtros -->
    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <form method="get" action="{% url 'indicadores_agenda' %}">
                <div class="row g-3 align-items-end">
                    <div class="col-md-2">
                        <label for="year" class="form-label">Ano</label>
                        <select name="year" id="year" class="form-select">
                            <option value="">Todos</option>
                            {% for y in anos_disponiveis %}
                                <option value="{{ y.year }}" {% if y.year == selected_year %}selected{% endif %}>{{ y.year }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="month" class="form-label">Mês</label>
                        <select name="month" id="month" class="form-select">
                            <option value="">Todos</option>
                            {% for num, nome in meses_disponiveis.items %}
                                <option value="{{ num }}" {% if num|as_int == selected_month %}selected{% endif %}>{{ nome }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="loja" class="form-label">Loja</label>
                        <select name="loja" id="loja" class="form-select">
                            <option value="">Todas</option>
                            {% for loja in lojas %}
                                <option value="{{ loja.id }}" {% if loja.id == selected_loja_id %}selected{% endif %}>{{ loja.nome }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="cliente" class="form-label">Cliente</label>
                        <select name="cliente" id="cliente" class="form-select">
                            <option value="">Todos</option>
                            {% for cliente in clientes %}
                                <option value="{{ cliente.id }}" {% if cliente.id == selected_cliente_id %}selected{% endif %}>{{ cliente.nome_completo }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="especificador" class="form-label">Especificador</label>
                        <select name="especificador" id="especificador" class="form-select">
                            <option value="">Todos</option>
                            {% for especificador in especificadores %}
                                <option value="{{ especificador.id }}" {% if especificador.id == selected_especificador_id %}selected{% endif %}>{{ especificador.nome_completo }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <button type="submit" class="btn btn-primary w-100"><i class="fas fa-filter me-2"></i>Filtrar</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Cards de KPIs -->
    <div class="row g-4 mb-4">
        <div class="col-md-3">
            <div class="card text-center h-100 shadow-sm">
                <div class="card-body">
                    <i class="fas fa-calendar-alt fa-3x text-primary mb-3"></i>
                    <h5 class="card-title">Total de Agendamentos</h5>
                    <p class="card-text fs-2 fw-bold">{{ indicadores_gerais.total }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center h-100 shadow-sm">
                <div class="card-body">
                    <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
                    <h5 class="card-title">Realizados</h5>
                    <p class="card-text fs-2 fw-bold">{{ indicadores_gerais.realizado }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center h-100 shadow-sm">
                <div class="card-body">
                    <i class="fas fa-times-circle fa-3x text-danger mb-3"></i>
                    <h5 class="card-title">Cancelados</h5>
                    <p class="card-text fs-2 fw-bold">{{ indicadores_gerais.cancelado }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center h-100 shadow-sm">
                <div class="card-body">
                    <i class="fas fa-users fa-3x text-info mb-3"></i>
                    <h5 class="card-title">Total de Visitantes</h5>
                    <p class="card-text fs-2 fw-bold">{{ total_visitantes }}</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Gráficos -->
    <div class="row g-4 mb-4">
        <div class="col-lg-6">
            <div class="card shadow-sm h-100">
                <div class="card-header"><i class="fas fa-building me-2"></i>Agendamentos por Loja</div>
                <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                    <ul class="list-group list-group-flush">
                        {% for loja in agendamentos_por_loja %}
                        <li class="list-group-item">
                            <div class="d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">{{ loja.loja__nome }}</h5>
                            </div>
                            <div class="d-flex justify-content-around mt-2 text-center">
                                <div>
                                    <i class="fas fa-calendar-alt fa-2x text-primary"></i>
                                    <p class="mb-0 mt-1">Total</p>
                                    <p class="fw-bold fs-5 mb-0">{{ loja.total }}</p>
                                </div>
                                <div>
                                    <i class="fas fa-check-circle fa-2x text-success"></i>
                                    <p class="mb-0 mt-1">Realizados</p>
                                    <p class="fw-bold fs-5 mb-0">{{ loja.realizados }}</p>
                                </div>
                            </div>
                        </li>
                        {% empty %}
                        <li class="list-group-item">Nenhum agendamento no período.</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="card shadow-sm h-100">
                <div class="card-header"><i class="fas fa-clipboard-list me-2"></i>Principais Motivos de Agendamento</div>
                <div class="card-body">
                    <canvas id="motivosChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    <div class="row g-4 mb-4">
         <div class="col-lg-6">
            <div class="card shadow-sm h-100">
                <div class="card-header"><i class="fas fa-star me-2"></i>Ranking de Consultores (Total de Agendamentos)</div>
                <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                    <ul class="list-group list-group-flush">
                        {% for consultor in ranking_consultores %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            {% if consultor.first_name %}
                                {{ consultor.first_name }} {{ consultor.last_name }}
                            {% else %}
                                {{ consultor.username }}
                            {% endif %}
                            <span class="badge bg-primary rounded-pill">{{ consultor.count }}</span>
                        </li>
                        {% empty %}
                        <li class="list-group-item">Nenhum consultor encontrado.</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="card shadow-sm h-100">
                <div class="card-header"><i class="fas fa-chart-pie me-2"></i>Status dos Agendamentos</div>
                <div class="card-body" style="max-height: 400px; text-align: center;">
                    <canvas id="statusChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super }}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Registrar o plugin globalmente
        Chart.register(ChartDataLabels);

        // Inicializar Choices.js para filtros
        new Choices('#cliente', { searchEnabled: true, removeItemButton: true });
        new Choices('#especificador', { searchEnabled: true, removeItemButton: true });

        // Gráfico de Status
        const statusCtx = document.getElementById('statusChart').getContext('2d');
        const statusData = [
                {{ indicadores_gerais.agendado|default:0 }},
                {{ indicadores_gerais.realizado|default:0 }},
                {{ indicadores_gerais.cancelado|default:0 }},
                {{ indicadores_gerais.nao_compareceu|default:0 }}
            ];
        const statusSum = statusData.reduce((a, b) => a + b, 0);

        new Chart(statusCtx, {
            type: 'doughnut',
            data: {
                labels: ['Agendado', 'Realizado', 'Cancelado', 'Não Compareceu'],
                datasets: [{
                    label: 'Status',
                    data: statusData,
                    backgroundColor: ['#0d6efd', '#198754', '#dc3545', '#6c757d'],
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    datalabels: {
                        formatter: (value, ctx) => {
                            if (statusSum === 0) {
                                return '0%';
                            }
                            let percentage = (value * 100 / statusSum).toFixed(2) + "%";
                            return percentage;
                        },
                        color: '#fff',
                        font: {
                            weight: 'bold'
                        }
                    }
                }
            }
        });
        
        // Gráfico de Motivos
        const motivosCtx = document.getElementById('motivosChart').getContext('2d');
        const motivosLabels = [{% for item in principais_motivos %}'{{ item.motivo }}',{% endfor %}];
        const motivosData = [{% for item in principais_motivos %}{{ item.count }},{% endfor %}];
        
        new Chart(motivosCtx, {
            type: 'bar',
            data: {
                labels: motivosLabels,
                datasets: [{
                    label: 'Quantidade',
                    data: motivosData,
                    backgroundColor: 'rgba(255, 159, 64, 0.6)',
                    borderColor: 'rgba(255, 159, 64, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                plugins: {
                    legend: { display: false },
                    datalabels: {
                        anchor: 'end',
                        align: 'start',
                        formatter: (value) => value,
                        color: '#444',
                        font: {
                            weight: 'bold'
                        }
                    }
                },
                scales: {
                    x: { beginAtZero: true }
                }
            }
        });
    });
</script>
{% endblock %}